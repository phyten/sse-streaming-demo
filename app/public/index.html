<!doctype html>
<html lang="ja">
  <meta charset="utf-8" />
  <title>SSE Streaming Demo</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 2rem; line-height: 1.6; }
    .row { display: flex; gap: 1rem; align-items: center; }
    #out, #out2 { white-space: pre-wrap; border: 1px solid #ddd; padding: 1rem; border-radius: 8px; min-height: 4rem; }
    input[type="text"] { width: 24rem; padding: .5rem; }
    button { padding: .5rem 1rem; cursor: pointer; }
    h2 { margin-top: 2rem; }
  </style>

  <h1>ChatGPT風ストリーミング（SSE / chunk）</h1>

  <div class="row">
    <input id="prompt" type="text" placeholder="プロンプト（任意）">
    <button id="start">SSE開始</button>
    <button id="stop">SSE停止</button>
  </div>
  <div id="out"></div>

  <h2>おまけ：fetch + ReadableStream（chunked）</h2>
  <div class="row">
    <button id="start2">/chunk にfetch</button>
    <button id="stop2">停止</button>
  </div>
  <div id="out2"></div>

  <script>
    const out = document.getElementById("out");
    const promptInput = document.getElementById("prompt");
    let es = null;

    function startSSE() {
      if (es) es.close();
      out.textContent = "";

      const u = new URL("/sse", window.location.origin);
      if (promptInput.value) u.searchParams.set("prompt", promptInput.value);

      es = new EventSource(u);
      es.addEventListener("token", (e) => {
        try { out.textContent += JSON.parse(e.data).text; }
        catch { out.textContent += e.data; }
      });
      es.addEventListener("done", () => es.close());
      es.addEventListener("error", (e) => { console.error("SSE error", e); es.close(); });
    }

    document.getElementById("start").onclick = startSSE;
    document.getElementById("stop").onclick  = () => es && es.close();

    const out2 = document.getElementById("out2");
    let readerAbort = null;

    async function startChunk() {
      out2.textContent = "";
      readerAbort && readerAbort.abort();
      readerAbort = new AbortController();

      const res = await fetch("/chunk", { signal: readerAbort.signal });
      if (!res.body) { out2.textContent = "ReadableStream未対応かも…"; return; }
      const reader = res.body.getReader();
      const decoder = new TextDecoder();

      try {
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          out2.textContent += decoder.decode(value, { stream: true });
        }
      } catch (e) {
        if (e.name !== "AbortError") console.error(e);
      }
    }

    document.getElementById("start2").onclick = startChunk;
    document.getElementById("stop2").onclick  = () => readerAbort && readerAbort.abort();
  </script>
</html>
